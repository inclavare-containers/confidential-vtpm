# 背景
虽然vTPM方案已被广泛部署在可信云中，但现有的vTPM方案缺乏对运行时环境中vTPM本身的保护。人们认识到安全攸关软件的重要性。起初，人们对使用安全机制来强化软件十分感兴趣，如使用控制流保护机制、权限裁剪、调停技术等。其中所有软件方法的前提建立在操作系统可信的基础上的。但随着现代操作系统功能愈加复杂，其漏洞也在不断变多。

可信执行环境的作用是利用硬件来提供可证明的隔离执行环境，该技术的应用在云平台上越来越普遍。TEE技术，如Intel SGX，现在已经成为安全攸关软件的参考解决方案。那么，**是否有可能利用新的软件设计的硬件基元的应用来保护vtpm？

已有前人进行了相关研究。然而，前人的研究忽视了通道安全的重要性、对TPM2.0命令的完整支持，同时引入了繁琐的软件重构工作。我们通过三个关键设计对以前的解决方案进行改造。为了解决第一个挑战，我们使用Rats-TLS协议（一个支持异构硬件可执行环境的相互传输层安全协议）加强了vTPM和tss软件栈之间的通道。对于第二个挑战，我们使用最新的tpm2-tools库中的完整测试案例测试我们的原型。最后，我们利用Occlum在飞地内运行vTPM，从而避免了传统方法中划分代码所造成的巨大成本。

# 设计与实现
我们实现了一个由两个容器组成的eTPM的原型：第一个容器包含有TSS软件栈和高层应用程序，高层应用程序利用tpm2-tools或tpm2-tss的接口来启动测试命令；第二个容器包含驻留在Occlum中的eTPM，它提供加密、验证和其他安全攸关的服务。当一个应用程序想要请求远程eTPM服务时，它利用tpm2-tools命令或tpm2-tss的API来连接eTPM。TPM2.0命令通过由Rats-TLS增强的信道传输。远程eTPM从默认端口接收命令并运行相应的计算程序。eTPM使用远程验证来保证完整性和保密性。发送方（eTPM）与接收方（TSS）紧密合作：发送方（eTPM）将SGX飞地中收集的证据传输给接收方（TSS）。然后，SGX的远程验证机制帮助后者验证信息的正确性。协商后，eTPM将结果返回给远程用户，如此完成一次交互。

# 后续工作

使用docker进行模拟是不够严谨的。为了迎合最初的假设，我们需要提供配备系统级虚拟机的概念验证。我们正在用Rats-TLS对QEMU的TPM后端进行改造，并探索前所未有的 "微软TPM模拟器-QEMU "的可行性。